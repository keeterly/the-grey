<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#f7f5f0" />
  <title>The Grey</title>

  <!-- Base styles -->
  <link rel="stylesheet" href="./assets/css/acceptance.safe.css" />
  <!-- Layout polish for mobile + HUD centering -->
  <link rel="stylesheet" href="./assets/css/mobile.css" />
</head>
<body>
  <div id="app"></div>

  <!-- ===================== -->
  <!--  GAME BUILD SETTINGS  -->
  <!-- ===================== -->
  <script>
    /* Visible build tag */
    window.__THE_GREY_BUILD = "v2.3.9-acceptanceP1-safe-v14";

    /* Explicit bundle entry for branch 2.2 (ES module) */
    window.__THE_GREY_ENTRY = "./src/ui/index.js";
  </script>

  <!-- ===================== -->
  <!--  SMART LOADER SYSTEM  -->
  <!-- ===================== -->
  <script>
    const log = (...a) => console.log("[the-grey loader]", ...a);
    const warn = (...a) => console.warn("[the-grey loader]", ...a);

    const singleFileCandidates = [
      "./src/ui/index.js",
      "./src/index.js",
      "./index.js",
      "./main.js",
      "./bundle.js",
      "./assets/js/main.js",
      "./dist/main.js"
    ];

    const multiFileSets = [
      ["./src/ui/index.js","./src/engine/rules.js","./src/engine/state.js","./src/ui/drag.js","./src/ui/animate.js"],
      ["./index.js","./rules.js","./state.js","./drags.js","./animate.js"],
      ["./assets/js/index.js","./assets/js/rules.js","./assets/js/state.js","./assets/js/drags.js","./assets/js/animate.js"]
    ];

    function loadScriptModule(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.type = "module";       // <<< IMPORTANT: load as ES module
        s.onload = () => resolve(src);
        s.onerror = () => {
          s.remove();
          reject(new Error("404 " + src));
        };
        document.head.appendChild(s);
      });
    }

    async function loadSingle(path) {
      log("trying single bundle:", path);
      await loadScriptModule(path);
      window.__TG_CORE_PATH__ = path;
      log("loaded:", path);
      return true;
    }

    async function loadMulti(list) {
      log("trying multi-file:", list.join(", "));
      for (const f of list) await loadScriptModule(f);
      window.__TG_CORE_PATH__ = list.join(", ");
      log("loaded:", window.__TG_CORE_PATH__);
      return true;
    }

    async function boot() {
      const manual = window.__THE_GREY_ENTRY;
      if (manual) {
        try {
          await loadSingle(manual);
          return afterCore();
        } catch (e) {
          warn("manual __THE_GREY_ENTRY failed:", e.message);
        }
      }

      for (const p of singleFileCandidates) {
        try { await loadSingle(p); return afterCore(); } catch {}
      }
      for (const set of multiFileSets) {
        try { await loadMulti(set); return afterCore(); } catch {}
      }
      renderError();
    }

    function afterCore() {
      // boot shim may also contain imports, so load as module as well
      const shim = document.createElement("script");
      shim.src = "./assets/js/boot-debug.js";
      shim.type = "module";
      document.head.appendChild(shim);
      log("boot-debug.js loaded");
    }

    function renderError() {
      const msg = document.createElement("div");
      msg.style.cssText =
        "position:fixed;inset:0;display:grid;place-items:center;font:14px/1.5 ui-sans-serif,system-ui,-apple-system;color:#5c5348;background:linear-gradient(#f7f5f0,#eee6d9)";
      msg.innerHTML = `
        <div style="max-width:720px;text-align:center;padding:24px 20px;border-radius:12px;background:#fff;box-shadow:0 8px 26px rgba(0,0,0,.10)">
          <div style="font-weight:700;margin-bottom:6px;">Couldnâ€™t find the game bundle</div>
          <div style="opacity:.8;margin-bottom:10px">
            Make sure your main file exists at <code>./src/ui/index.js</code>
            or update <code>window.__THE_GREY_ENTRY</code> in <strong>index.html</strong>.
          </div>
        </div>`;
      document.body.appendChild(msg);
    }

    boot();
  </script>
</body>
</html>
