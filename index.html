<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Grey — Spellweavers (Light)</title>
<meta name="theme-color" content="#e8e2d4" />
<style>
/* =========================
   NieR-style LIGHT THEME
   ========================= */
:root{
  /* Parchment base with graphite ink + soft gold accents */
  --bg:#ece6d8;            /* page */
  --bg-grad:#f4efe4;       /* subtle vignette */
  --ink:#1d1f21;           /* main text (graphite) */
  --muted:#51565c;         /* muted graphite */
  --accent:#9b8e69;        /* warm desaturated gold */

  --panel:#f6f2e8;         /* zones & cards */
  --panel-2:#f0eadf;       /* chips/hud */
  --line:#d8d2c6;          /* hard edge line */
  --line-soft:#e5decf;

  --slot:#faf6ee;          /* slot bg */

  --chip:#f3ede2;
  --chip-line:#d8d1c4;

  --card:#faf6ee;
  --card-line:#d9d2c6;

  --fade:#ece6d8;

  --card-w:120px; --card-h:172px; --card-radius:12px;

  --shadow-soft:0 2px 10px rgba(90,78,58,.12);
  --shadow-panel:0 1px 6px rgba(70,60,45,.08) inset, 0 1px 10px rgba(80,70,55,.05);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{min-height:100%}
body{
  background:
    radial-gradient(1200px 700px at 50% -240px, rgba(120,100,70,.08), transparent 60%),
    var(--bg-grad);
  color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif;
  letter-spacing:.005em;-webkit-font-smoothing:antialiased;overflow-x:hidden;
}

/* ========== HUD ========== */
.hudFloat{position:fixed;top:12px;z-index:70;display:flex;flex-direction:column;gap:8px}
.hudFloat.left{left:12px}
.hudFloat.right{right:12px;align-items:flex-end}
.hchip{
  display:flex;align-items:center;gap:8px;
  padding:8px 10px;border-radius:12px;
  background:linear-gradient(180deg,var(--panel-2),#fff);
  border:1px solid var(--chip-line);
  color:var(--ink);font-size:13px;box-shadow:var(--shadow-soft)
}
.hchip .icon{width:16px;height:16px;display:grid;place-items:center;color:var(--accent)}

/* ========== CONTAINERS ========== */
.wrap{padding:14px;max-width:1100px;margin:auto;padding-bottom:170px}
.zone{
  background:linear-gradient(180deg,#fff,var(--panel));
  border:1px solid var(--line);
  border-radius:14px;padding:12px;margin-bottom:12px;
  box-shadow:var(--shadow-panel)
}
.title{font-weight:700;letter-spacing:.02em;color:var(--accent);margin-bottom:8px}

/* ===== Boards ===== */
.slots{display:flex;gap:10px;flex-wrap:wrap}
.slot{
  flex:1 0 30%;
  background:var(--slot);
  border:2px dashed #cec6b7;border-radius:12px;
  padding:10px;min-height:146px;position:relative
}
.slot h5{font-size:12px;color:#6a6f76;margin-bottom:6px;letter-spacing:.01em}
.pips{display:flex;gap:4px;margin-top:6px}
.pip{width:10px;height:10px;border-radius:999px;border:1px solid #b8b2a4;background:#efe9dc}
.pip.on{background:#7a838c;border-color:#7a838c}

/* ===== Glyphs ===== */
.glyphTray{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 8px}
.glyphTok{
  position:relative;display:inline-flex;align-items:center;justify-content:center;
  min-width:46px;height:28px;border-radius:8px;background:var(--panel-2);border:1px solid var(--chip-line);
  color:#3a3d40;font-size:11px;box-shadow:var(--shadow-soft);padding:0 8px
}
.glyphTok::before{content:'✦';opacity:.95;font-size:12px;color:var(--accent)}
.glyphTok.own{cursor:pointer}
.glyphPeek{
  position:absolute;left:50%;bottom:110%;transform:translateX(-50%);
  background:#fff;border:1px solid var(--line);color:#222;
  padding:6px 8px;border-radius:10px;font-size:11px;white-space:nowrap;box-shadow:0 10px 22px rgba(60,50,40,.18);display:none
}
.glyphTok.own:hover .glyphPeek,.glyphTok.own:focus .glyphPeek{display:block}

/* ===== Aetherflow ===== */
.flowArea{position:relative}
.flowWrap{overflow-x:auto;scrollbar-width:none;mask-image:linear-gradient(90deg,transparent 0,var(--fade) 24px,#fff calc(100% - 24px),transparent 100%)}
.flowWrap::-webkit-scrollbar{display:none}
.flowGrid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;min-width:820px}
.costCell{display:flex;justify-content:center}
.costChip{min-width:42px;text-align:center;font-weight:800;letter-spacing:.04em;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--accent);font-size:12px}
.marketCard{
  background:var(--card);border:1px solid var(--card-line);border-radius:14px;padding:10px;min-height:136px;position:relative;
  box-shadow:0 4px 14px rgba(70,60,45,.12)
}
.marketCard h4{font-size:14px;color:var(--accent);margin-bottom:6px;letter-spacing:.01em}
.marketCard p{font-size:12px;color:var(--muted);margin-bottom:8px}
.marketCard .actions{display:flex;gap:8px}
.marketCard .actions button{
  padding:7px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--ink);letter-spacing:.01em
}
.marketBadge{
  position:absolute;top:8px;right:10px;border:1px solid var(--line);background:#fff;color:#554c38;
  padding:2px 6px;border-radius:8px;font-size:11px;letter-spacing:.01em
}
.placeholder{opacity:.45;display:grid;place-items:center;border-style:dashed}

/* ===== Toast ===== */
.topLog{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#fff;border:1px solid var(--line);color:#2a2e33;border-radius:12px;padding:9px 12px;box-shadow:0 8px 18px rgba(70,60,45,.18);z-index:80;display:none;max-width:92vw;font-size:12px;letter-spacing:.01em}
.topLog.show{display:block}

/* ===== Hand ribbon ===== */
.ribbon-wrap{position:fixed;left:0;right:0;bottom:0;z-index:40;padding:10px 8px calc(12px + env(safe-area-inset-bottom));background:linear-gradient(0deg,#f2ece1,#f8f3ea);border-top:1px solid var(--line)}
.ribbon{display:flex;align-items:flex-end;gap:6px;height:118px;overflow-x:auto;scrollbar-width:none}
.ribbon::-webkit-scrollbar{display:none}
.rCard{
  width:var(--card-w);height:var(--card-h);border-radius:var(--card-radius);overflow:hidden;background:#fff;border:1px solid var(--card-line);box-shadow:0 6px 14px rgba(70,60,45,.18);transform:translateY(46%);display:flex;flex-direction:column;user-select:none
}
.rHead{padding:7px 9px 6px;font-size:11px;font-weight:800;letter-spacing:.02em;background:linear-gradient(180deg,#ffffff,#f4eee3);border-bottom:1px solid var(--line);color:var(--accent);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rArt{position:relative;flex:1;display:grid;place-items:center;background:linear-gradient(180deg,#f7f2e9,#fcfaf6)}
.rArt img{width:100%;height:100%;object-fit:contain;display:block;filter:saturate(.9) contrast(1.02)}
.rFoot{padding:6px 8px 7px;font-size:11px;color:#656b70;border-top:1px solid var(--line);background:#fcfaf6;line-height:1.25;letter-spacing:.01em}
.badgeTL,.badgeTR{position:absolute;top:6px;padding:2px 6px;border-radius:8px;font-size:10px;font-weight:700;background:#fff;border:1px solid var(--line);color:#4a4e52;letter-spacing:.02em}
.badgeTL{left:6px}.badgeTR{right:6px}

/* ===== Inspect modal ===== */
.inspectBack{position:fixed;inset:0;z-index:75;background:rgba(20,20,20,.25);display:none;align-items:flex-end;justify-content:center;padding-bottom:140px}
.inspectBack.show{display:flex}
.inspectCard{min-width:min(580px,92vw);max-width:92vw;background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 14px 32px rgba(70,60,45,.22);padding:12px 14px}
.inspectCard h3{margin:0 0 6px;font-size:16px;font-weight:800;color:var(--accent);letter-spacing:.01em}
.inspectCard p{margin:0 0 8px;font-size:13px;color:#2b2f33;letter-spacing:.01em}
.inspectCard .artBox{height:190px;border-radius:10px;overflow:hidden;margin:6px 0 10px;border:1px solid var(--line);background:#fcfaf6;display:grid;place-items:center}
.inspectCard .artBox img{width:100%;height:100%;object-fit:contain}
.inspectActions{display:flex;gap:8px;justify-content:flex-end}
.inspectActions button{padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:#1f2225}

/* ===== Deck / Discard + FAB ===== */
.deckBar{position:fixed;left:12px;bottom:126px;z-index:50;display:flex;gap:8px}
.chip{display:flex;align-items:center;gap:6px;padding:7px 12px;border-radius:999px;background:#fff;border:1px solid var(--line);color:#1f2326;font-size:12px}
.fabDial{position:fixed;right:12px;bottom:126px;z-index:50;display:flex;flex-direction:column;gap:12px}
.fab{width:46px;height:46px;border-radius:999px;background:#fff;border:1px solid var(--line);display:grid;place-items:center;color:#1d1f21;font-size:18px;box-shadow:var(--shadow-soft)}

/* slot highlight on drag */
#playerSlots .slot.is-hot{outline:2px solid var(--accent);outline-offset:2px}
</style>
</head>
<body>

<!-- HUD -->
<div class="hudFloat left">
  <div class="hchip"><span class="icon">❤️</span><b id="hp">5</b></div>
  <div class="hchip"><span class="icon">⚡</span><b id="ae">0</b></div>
  <div class="hchip" style="padding:4px 8px"><span id="turnTag" style="font-size:12px">Turn 1</span></div>
</div>
<div class="hudFloat right">
  <div class="hchip">AI&nbsp;<span class="icon">❤️</span><b id="aiHp">5</b></div>
  <div class="hchip"><span class="icon">⚡</span><b id="aiAe">0</b></div>
  <div class="hchip"><span class="icon">✦</span><b id="aiGlyphs">0</b></div>
</div>

<!-- Toast -->
<div id="topLog" class="topLog" aria-live="polite"></div>

<div class="wrap">
  <!-- AI Board -->
  <div class="zone">
    <div class="title">AI Board</div>
    <div class="slots" id="aiSlots"></div>
  </div>

  <!-- Aetherflow -->
  <div class="zone flowArea">
    <div class="title" style="text-align:center">Aetherflow</div>
    <div class="flowWrap">
      <div class="flowGrid">
        <!-- cost row -->
        <div class="costCell"><div class="costChip">4</div></div>
        <div class="costCell"><div class="costChip">3</div></div>
        <div class="costCell"><div class="costChip">2</div></div>
        <div class="costCell"><div class="costChip">2</div></div>
        <div class="costCell"><div class="costChip">2</div></div>
        <!-- cards -->
        <div class="marketCard" data-flow="0"></div>
        <div class="marketCard" data-flow="1"></div>
        <div class="marketCard" data-flow="2"></div>
        <div class="marketCard" data-flow="3"></div>
        <div class="marketCard" data-flow="4"></div>
      </div>
    </div>
  </div>

  <!-- Player Board -->
  <div class="zone">
    <div class="title">Your Board</div>
    <div class="glyphTray" id="glyphTray"></div>
    <div class="slots" id="playerSlots"></div>
  </div>
</div>

<!-- Deck / Discard + FAB -->
<div class="deckBar">
  <div class="chip">Deck <span id="deckCount">0</span></div>
  <div class="chip">Discard <span id="discardCount">0</span></div>
</div>
<div class="fabDial">
  <button id="fabDraw"  class="fab" title="Draw">⇧</button>
  <button id="fabEnd"   class="fab" title="End Turn">⏵</button>
  <button id="fabReset" class="fab" title="Reset">↺</button>
</div>

<!-- Hand ribbon -->
<section class="ribbon-wrap"><div class="ribbon" id="ribbon"></div></section>

<!-- Inspect -->
<div id="inspect" class="inspectBack" role="dialog" aria-modal="true">
  <div class="inspectCard">
    <h3 id="insTitle">Card</h3>
    <div class="artBox"><img id="insArt" alt="" loading="lazy"></div>
    <p id="insText"></p>
    <div class="inspectActions">
      <button id="btnInspectPlay">Play/Set</button>
      <button id="btnInspectChan">Channel</button>
      <button id="btnInspectClose" aria-label="Close">Close</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Data
   ========================= */
const HAND_DRAW=5;
const FLOW_PRICES=[4,3,2,2,2];

const STARTER=[
  {n:'Apprentice Bolt',t:'Spell',txt:'Deal 1.',p:1,artKey:'apprentice-bolt'},
  {n:'Apprentice Bolt',t:'Spell',txt:'Deal 1.',p:1,artKey:'apprentice-bolt'},
  {n:'Apprentice Bolt',t:'Spell',txt:'Deal 1.',p:1,artKey:'apprentice-bolt'},
  {n:'Kindle',t:'Spell',txt:'On resolve: +1⚡.',p:2,eff:'gain1',artKey:'kindle'},
  {n:'Glacial Ward',t:'Glyph',txt:'Prevent 1 next hit.',eff:'g_barrier',artKey:'glacial-ward'},
  {n:'Mirror Ward',t:'Glyph',txt:'Reflect next damage (sim).',eff:'g_mirror',artKey:'mirror-ward'},
  {n:'Ward Sigil',t:'Glyph',txt:'Prevent 1 (sim).',eff:'g_barrier',artKey:'ward-sigil'},
  {n:'Meditate',t:'Instant',txt:'↺ +1⚡ (or play +1⚡).',v:1,artKey:'meditate'}
];
const ECON_CARDS=[
  {n:'Aether Pebble',t:'Instant',txt:'↺ +1⚡ (or play +1⚡).',v:1,artKey:'aether-pebble'},
  {n:'Aether Shard',t:'Instant',txt:'↺ +2⚡ (or play +2⚡).',v:2,artKey:'aether-shard'},
  {n:'Aether Core',t:'Instant',txt:'↺ +3⚡ (or play +3⚡).',v:3,artKey:'aether-core'}
];
const OFFENSE_CARDS=[
  {n:'Spark Javelin',t:'Spell',txt:'Deal 2.',p:1,v:1,artKey:'spark-javelin'},
  {n:'Flame Lash',t:'Spell',txt:'Deal 2 then 3.',p:2,v:0,artKey:'flame-lash'},
  {n:'Ember',t:'Spell',txt:'Deal 2.',p:1,v:0,artKey:'ember'},
  {n:'Frost Bolt',t:'Spell',txt:'Deal 1; slow next hit (sim).',p:2,v:0,artKey:'frost-bolt'},
  {n:'Siphon Hex',t:'Spell',txt:'Drain 1⚡ from foe.',p:2,v:1,eff:'drain1',artKey:'siphon-hex'},
  {n:'Stonewall',t:'Spell',txt:'+1 advance tax (foe).',p:2,v:0,eff:'tax',artKey:'stonewall'}
];
const FLOW_POOL=[...ECON_CARDS,...OFFENSE_CARDS];

/* =========================
   Procedural SVG art tuned for LIGHT
   ========================= */
function artSVG({motif='aether'}={}) {
  const gold='#9b8e69', graphite='#25282b', bone='#474b50';
  const fx={
    fire:`<path d="M150 190c-18-38 12-64 26-90-4 30 18 46 8 78 34-14 48-48 44-92 36 38 32 86-22 122-22 16-44 24-56 26z" fill="${gold}" opacity=".85"/>`,
    lightning:`<path d="M160 120l-48 72h36l-40 60 88-98h-34l30-34z" fill="${bone}" opacity=".9"/>`,
    ice:`<g fill="${bone}" opacity=".85"><path d="M180 120l16 40 40 16-40 16-16 40-16-40-40-16 40-16z"/></g>`,
    aether:`<circle cx="200" cy="180" r="34" fill="none" stroke="${gold}" stroke-width="4" opacity=".9"/>`,
    ward:`<g stroke="${gold}" stroke-width="3" opacity=".9" fill="none"><circle cx="200" cy="180" r="40"/><path d="M200 140l24 40h-48z"/><circle cx="200" cy="180" r="8" stroke-width="2"/></g>`,
    hex:`<g fill="none" stroke="${bone}" opacity=".9"><path d="M164 160h72v40h-72z" stroke-width="3"/><path d="M164 180h72" stroke-width="6" opacity=".4"/></g>`,
    stone:`<g fill="${gold}" opacity=".28"><rect x="172" y="156" width="20" height="32"/><rect x="196" y="148" width="24" height="40"/><rect x="224" y="164" width="18" height="24"/></g>`,
    meditate:`<g fill="none" stroke="${gold}" stroke-width="3" opacity=".9"><circle cx="200" cy="180" r="28"/><circle cx="200" cy="180" r="44" opacity=".45"/></g>`
  }[motif]||'';
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(`
  <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 420'>
    <defs>
      <filter id='g'><feTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2'/><feComponentTransfer><feFuncA type='table' tableValues='0 .08'/></feComponentTransfer></filter>
      <linearGradient id='v' x1='0' x2='0' y1='0' y2='1'><stop offset='0' stop-color='#f7f2e9'/><stop offset='1' stop-color='#fff'/></linearGradient>
    </defs>
    <rect width='100%' height='100%' fill='url(#v)'/>
    <rect width='100%' height='100%' filter='url(#g)' opacity='.12'/>
    <g transform='translate(-40 0)'>${fx}</g>
  </svg>`);
}
const ART_MAP={
  'flame-lash':artSVG({motif:'fire'}),'spark-javelin':artSVG({motif:'lightning'}),
  'frost-bolt':artSVG({motif:'ice'}),'ember':artSVG({motif:'fire'}),
  'siphon-hex':artSVG({motif:'hex'}),'stonewall':artSVG({motif:'stone'}),
  'aether-core':artSVG({motif:'aether'}),'aether-shard':artSVG({motif:'aether'}),
  'aether-pebble':artSVG({motif:'aether'}),'meditate':artSVG({motif:'meditate'}),
  'glacial-ward':artSVG({motif:'ward'}),'mirror-ward':artSVG({motif:'ward'}),
  'ward-sigil':artSVG({motif:'ward'}),'apprentice-bolt':artSVG({motif:'lightning'}),
  'kindle':artSVG({motif:'fire'})
};
const slug=s=>(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
function resolveArt(c){const k=(c&&(c.artKey||slug(c.n)))||'card';return ART_MAP[k]||ART_MAP['aether-core'];}

/* =========================
   DOM helpers
   ========================= */
const hp=qs('#hp'), aiHp=qs('#aiHp'), ae=qs('#ae'), aiAe=qs('#aiAe'), aiGlyphs=qs('#aiGlyphs');
const deckCount=qs('#deckCount'), discardCount=qs('#discardCount');
const playerSlots=qs('#playerSlots'), aiSlots=qs('#aiSlots'), glyphTray=qs('#glyphTray');
const rRibbon=qs('#ribbon'), topLog=qs('#topLog'), turnTag=qs('#turnTag');
const inspect=qs('#inspect'), insTitle=qs('#insTitle'), insText=qs('#insText'), insArt=qs('#insArt');
const marketCells=[...document.querySelectorAll('[data-flow]')];
const fabDraw=qs('#fabDraw'), fabEnd=qs('#fabEnd'), fabReset=qs('#fabReset');

let S={}, turnLog=[], hideTimer, inspectIndex=-1;

function qs(s,r=document){return r.querySelector(s)}
function qsa(s,r=document){return r.querySelectorAll(s)}
function uid(){return Math.random().toString(36).slice(2,9)}
function shuf(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function makeStarterDeck(){return shuf(STARTER.map(x=>({...x,id:uid()})))}
function makeFlowDeck(){return shuf(FLOW_POOL.map(x=>({...x,id:uid()})))}
function log(m){turnLog.push(m); topLog.innerHTML=turnLog.slice(-3).map(x=>`<div>${x}</div>`).join(''); topLog.classList.add('show'); clearTimeout(hideTimer); hideTimer=setTimeout(()=>topLog.classList.remove('show'),2200)}
function logResetTurn(){turnLog=[]; topLog.classList.remove('show')}

/* =========================
   Game core + AI
   ========================= */
function initGame(){
  S={hp:5,ae:0,deck:makeStarterDeck(),hand:[],disc:[],slots:[null,null,null],glyphs:[],
     ai:{hp:5,ae:0,deck:makeStarterDeck(),hand:[],disc:[],slots:[null,null,null],glyphs:[]},
     flowDeck:makeFlowDeck(),flowRow:[null,null,null,null,null],turn:1};
  ensureMarket(true);
  startTurn(true);
}
function startTurn(first=false){
  if(!first) S.turn++;
  logResetTurn();
  while(S.hand.length<HAND_DRAW) drawCard();
  render();
  log(`Turn ${S.turn} — drew to ${HAND_DRAW}.`);
}
function endTurn(){
  S.slots.forEach(s=>{ if(s) s.advUsed=false; });
  slideFlow();
  if(S.hand.length){ S.disc.push(...S.hand); S.hand.length=0; log("End Turn: auto-discard hand."); }
  render();
  setTimeout(()=>aiTurn(),300);
  setTimeout(()=>startTurn(false),800);
}
function drawCard(){
  if(S.deck.length===0){
    if(S.disc.length===0){ log("No cards to draw."); return; }
    S.deck=shuf(S.disc); S.disc=[]; log("You reshuffle.");
  }
  S.hand.push(S.deck.pop());
}

/* =========================
   Render
   ========================= */
function render(){
  hp.textContent=S.hp; aiHp.textContent=S.ai.hp; ae.textContent=S.ae; aiAe.textContent=S.ai.ae||0;
  deckCount.textContent=S.deck.length; discardCount.textContent=S.disc.length;
  aiGlyphs.textContent=S.ai.glyphs.length; turnTag.textContent=`Turn ${S.turn}`;

  // player board
  playerSlots.innerHTML='';
  S.slots.forEach((s,i)=>{
    const d=document.createElement('div'); d.className='slot'; d.innerHTML=`<h5>Slot ${i+1}</h5>`;
    if(s){
      d.innerHTML+=`<div class="marketCard" style="min-width:auto;max-width:none;margin-bottom:8px">
        <h4>${s.c.n}</h4><p>${s.c.txt||''}</p>
        <div class="pips">${pips(s.ph,s.c.p||1)}</div></div>
        <button style="padding:7px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;color:#1f2326" ${s.advUsed?'disabled':''}>Advance (1⚡)</button>`;
      if(!s.advUsed) d.querySelector('button').onclick=()=>advance(i);
    }
    playerSlots.appendChild(d);
  });

  // AI board
  aiSlots.innerHTML='';
  S.ai.slots.forEach((s,i)=>{
    const d=document.createElement('div'); d.className='slot'; d.innerHTML=`<h5>AI Slot ${i+1}</h5>`;
    if(s) d.innerHTML+=`<div class="marketCard" style="min-width:auto"><h4>${s.c.n}</h4><div class="pips">${pips(s.ph,s.c.p||1)}</div></div>`;
    aiSlots.appendChild(d);
  });

  // market
  for(let i=0;i<5;i++){
    const c=S.flowRow[i]; const el=marketCells[i];
    if(!c){ el.classList.add('placeholder'); el.textContent='— empty —'; continue; }
    el.classList.remove('placeholder'); el.innerHTML='';
    const badge=(c.v!=null)?`<span class="marketBadge">↺ +${c.v}⚡</span>`:'';
    el.innerHTML=`${badge}<h4>${c.n}</h4>
      <div style="height:128px;border-radius:10px;overflow:hidden;border:1px solid var(--line);background:#fff;display:grid;place-items:center;margin-bottom:6px">
        <img src="${resolveArt(c)}" alt="" style="width:100%;height:100%;object-fit:contain">
      </div>
      <p>${c.txt||''}</p>
      <div class="actions"><button ${S.ae>=FLOW_PRICES[i]?'':'disabled'}>Buy (${FLOW_PRICES[i]}⚡)</button></div>`;
    el.querySelector('button').onclick=()=>buyFlow(i);
  }

  // glyphs
  glyphTray.innerHTML=S.glyphs.map(g=>`<button class="glyphTok own"><span class="glyphPeek">${g.n}: ${g.txt||'Glyph'}</span></button>`).join('')||`<span style="font-size:11px;color:#888e93">No glyphs set.</span>`;

  renderHand();
}
function pips(cur,total){let h='';for(let i=1;i<=total;i++)h+=`<span class="pip ${i<=cur?'on':''}"></span>`;return h;}
function renderHand(){
  rRibbon.innerHTML='';
  S.hand.forEach((c,i)=>{
    const card=document.createElement('button'); card.type='button'; card.className='rCard'; card.dataset.index=i;
    card.innerHTML=`<div class="rHead">${c.n}</div>
    <div class="rArt">
      ${(c.v!=null?`<div class="badgeTR">↺ +${c.v}⚡</div>`:'')}
      ${(c.t==='Spell'?`<div class="badgeTL">${'●'.repeat(c.p||1)}</div>`:'')}
      <img src="${resolveArt(c)}" alt="${c.n}">
    </div>
    <div class="rFoot">${c.txt||''}</div>`;
    card.addEventListener('click',()=>openInspect(i));
    prepDrag(card,i);
    rRibbon.appendChild(card);
  });
}

/* =========================
   Inspect
   ========================= */
function openInspect(i){const c=S.hand[i]; if(!c) return; inspectIndex=i; insTitle.textContent=c.n; insText.textContent=c.txt||''; insArt.src=resolveArt(c); inspect.classList.add('show');}
function closeInspect(){inspect.classList.remove('show');inspectIndex=-1;}
qs('#btnInspectClose').onclick=closeInspect;
qs('#btnInspectPlay').onclick=()=>{if(inspectIndex>-1){playFromHandIndex(inspectIndex);closeInspect();}}
qs('#btnInspectChan').onclick=()=>{if(inspectIndex>-1){channelFromHandIndex(inspectIndex);closeInspect();}}

/* =========================
   Drag to slot
   ========================= */
function prepDrag(card,i){
  card.addEventListener('dragstart',e=>e.preventDefault());
  let ghost=null,isDown=false,drag=false; let t;
  card.addEventListener('pointerdown',e=>{isDown=true;drag=false;t=setTimeout(()=>{if(!drag)openInspect(i)},350);card.setPointerCapture(e.pointerId);e.preventDefault();});
  card.addEventListener('pointermove',e=>{
    if(!isDown) return;
    if(Math.hypot(e.movementX,e.movementY)>6 && !drag){drag=true;clearTimeout(t);ghost=card.cloneNode(true);Object.assign(ghost.style,{position:'fixed',left:'0',top:'0',transform:'translate(-50%,-50%) scale(1.02)',pointerEvents:'none',opacity:.95,zIndex:999});document.body.appendChild(ghost);}
    if(drag && ghost){ghost.style.left=e.clientX+'px';ghost.style.top=e.clientY+'px';highlightDrop(e.clientX,e.clientY);}
  });
  card.addEventListener('pointerup',e=>{
    clearTimeout(t);
    if(drag && ghost){const idx=dropIndex(e.clientX,e.clientY); if(idx!=null) playFromHandIndex(i,idx); ghost.remove(); unhot(); }
    isDown=false; drag=false; ghost=null;
  });
  card.addEventListener('pointercancel',()=>{unhot(); isDown=false; drag=false; if(ghost)ghost.remove();});
}
function highlightDrop(x,y){[...qsa('#playerSlots .slot')].forEach(s=>s.classList.toggle('is-hot',hit(s,x,y))); }
function unhot(){[...qsa('#playerSlots .slot')].forEach(s=>s.classList.remove('is-hot'))}
function hit(el,x,y){const r=el.getBoundingClientRect();return x>=r.left&&x<=r.right&&y>=r.top&&y<=r.bottom}
function dropIndex(x,y){const A=[...qsa('#playerSlots .slot')];const i=A.findIndex(s=>hit(s,x,y));return i>-1?i:null}

/* =========================
   Actions & Resolve
   ========================= */
function playFromHandIndex(idx,slotIdx=null){
  const c=S.hand[idx]; if(!c) return;
  if(c.t==='Spell'){let s=(slotIdx!=null?slotIdx:S.slots.findIndex(x=>!x)); if(s<0){log("No empty slot."); return;} S.slots[s]={c,ph:1,advUsed:false}; S.hand.splice(idx,1); log(`Play ${c.n} → Slot ${s+1}.`);}
  else if(c.t==='Glyph'){S.glyphs.push(c); S.hand.splice(idx,1); log(`Set glyph: ${c.n}.`);}
  else{S.ae+=(c.v||0); S.disc.push(c); S.hand.splice(idx,1); log(`Cast ${c.n}: +${c.v||0}⚡.`);}
  render();
}
function channelFromHandIndex(idx){const c=S.hand[idx]; if(!c) return; S.ae+=(c.v||0); S.disc.push(c); S.hand.splice(idx,1); log(`Channel ${c.n}: +${c.v||0}⚡.`); render();}
function advance(i){const s=S.slots[i]; if(!s) return; if(S.ae<1){log("Need 1⚡ to advance."); return;} S.ae-=1; s.ph++; s.advUsed=true; if(s.ph>=(s.c.p||1)) resolvePlayer(i); render();}
function resolvePlayer(i){const s=S.slots[i]; if(!s) return; runResolve('you',s.c); S.disc.push(s.c); S.slots[i]=null; render();}
function runResolve(who,c){
  switch(c.eff){
    case 'gain1': if(who==='you'){S.ae+=1; log(`${c.n} resolves: +1⚡.`);} else {S.ai.ae+=1; log(`AI gains +1⚡.`);} break;
    case 'drain1': if(who==='you'){S.ai.ae=Math.max(0,S.ai.ae-1); log(`${c.n}: drain 1⚡ (AI).`);} else {S.ae=Math.max(0,S.ae-1); log(`AI drains 1⚡.`);} break;
    case 'tax': if(who==='you'){log(`${c.n}: foe’s next Advance +1⚡ (sim).`);} else {log(`AI taxes your next Advance (sim).`);} break;
    default:
      if(c.t==='Spell'){
        if(c.n==='Flame Lash'){log((who==='you'?'You':'AI')+" Flame Lash deals 5 total (sim).");}
        else if(c.n==='Ember'){log((who==='you'?'You':'AI')+" Ember deals 2 (sim).");}
        else if(c.n==='Spark Javelin'){log((who==='you'?'You':'AI')+" Spark Javelin deals 2 (sim).");}
        else if(c.n==='Frost Bolt'){log((who==='you'?'You':'AI')+" Frost Bolt slows (sim).");}
        else {log(`${c.n} resolves.`);}
      } else {log(`${c.n} resolves.`);}
  }
}

/* =========================
   Simple AI
   ========================= */
function aiDraw(){ if(S.ai.deck.length===0){ if(S.ai.disc.length>0){ S.ai.deck=shuf(S.ai.disc); S.ai.disc=[]; log("AI reshuffles."); } else return; } S.ai.hand.push(S.ai.deck.pop()); }
function aiTurn(){
  while(S.ai.hand.length<5) aiDraw();

  const idxSpell=S.ai.hand.findIndex(x=>x.t==='Spell');
  if(idxSpell>-1){
    const c=S.ai.hand.splice(idxSpell,1)[0];
    const s=S.ai.slots.findIndex(x=>!x);
    if(s>-1){ S.ai.slots[s]={c,ph:1,advUsed:false}; log("AI plays "+c.n); }
  }
  const idxInst=S.ai.hand.findIndex(x=>x.t==='Instant');
  if(idxInst>-1){ const r=S.ai.hand.splice(idxInst,1)[0]; S.ai.ae+=(r.v||0); S.ai.disc.push(r); log("AI channels "+r.n+" (+ "+(r.v||0)+"⚡)"); }

  const sIdx=S.ai.slots.findIndex(s=>s && !s.advUsed && S.ai.ae>0);
  if(sIdx>-1){ S.ai.ae--; S.ai.slots[sIdx].ph++; S.ai.slots[sIdx].advUsed=true; log("AI advances."); if(S.ai.slots[sIdx].ph>= (S.ai.slots[sIdx].c.p||1)){ runResolve('ai',S.ai.slots[sIdx].c); S.ai.disc.push(S.ai.slots[sIdx].c); S.ai.slots[sIdx]=null; } }

  for(let i=4;i>=0;i--){ const c=S.flowRow[i]; if(c && FLOW_PRICES[i] <= (S.ai.ae||0)){ S.ai.ae -= FLOW_PRICES[i]; S.ai.disc.push(c); S.flowRow[i]=null; log("AI buys "+c.n); break; } }
  ensureMarket(); render();
}

/* =========================
   Market
   ========================= */
function ensureMarket(initial=false){ for(let i=0;i<5;i++){ if(!S.flowRow[i]) S.flowRow[i]=drawFlow(); } if(initial) render(); }
function drawFlow(){ if(S.flowDeck.length===0) S.flowDeck=makeFlowDeck(); return S.flowDeck.pop()||null; }
function buyFlow(i){
  const c=S.flowRow[i]; if(!c){log("Empty slot."); return;}
  const cost=FLOW_PRICES[i]; if(S.ae<cost){log("Not enough ⚡."); return;}
  S.ae-=cost; S.disc.push(c); S.flowRow[i]=null; log(`Bought ${c.n} for ${cost}⚡.`); ensureMarket(); render();
}
function slideFlow(){ S.flowRow.pop(); S.flowRow.unshift(drawFlow()); }

/* =========================
   Buttons
   ========================= */
fabDraw.onclick=()=>{ if(S.hand.length<HAND_DRAW){ drawCard(); render(); log("Manual draw."); } };
fabEnd.onclick =()=> endTurn();
fabReset.onclick=()=> initGame();

/* =========================
   Boot
   ========================= */
initGame();
</script>
</body>
</html>